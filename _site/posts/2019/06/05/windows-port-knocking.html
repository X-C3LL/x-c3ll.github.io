<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Stealthier communications &amp; Port Knocking via Windows Filtering Platform (WFP) | Doomsday Vault</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Stealthier communications &amp; Port Knocking via Windows Filtering Platform (WFP)" />
<meta name="author" content="X-C3LL" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Example of how WFP can be used to communicate with an infected machine" />
<meta property="og:description" content="Example of how WFP can be used to communicate with an infected machine" />
<link rel="canonical" href="http://localhost:4000/posts/2019/06/05/windows-port-knocking.html" />
<meta property="og:url" content="http://localhost:4000/posts/2019/06/05/windows-port-knocking.html" />
<meta property="og:site_name" content="Doomsday Vault" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-05T15:30:07+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Stealthier communications &amp; Port Knocking via Windows Filtering Platform (WFP)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"X-C3LL"},"dateModified":"2019-06-05T15:30:07+02:00","datePublished":"2019-06-05T15:30:07+02:00","description":"Example of how WFP can be used to communicate with an infected machine","headline":"Stealthier communications &amp; Port Knocking via Windows Filtering Platform (WFP)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/2019/06/05/windows-port-knocking.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/logo.jpg"},"name":"X-C3LL"},"url":"http://localhost:4000/posts/2019/06/05/windows-port-knocking.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=c27a30cb27997bd3ed45ba5a77bd97bd27cbeb64">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header>

        <h1><a href="http://localhost:4000/">Doomsday Vault</a></h1>

        
          <img src="/assets/img/logo.jpg" alt="Logo" />
        

        <p>X-C3LL's Personal Blog :)</p>


        
        <ul class="downloads">
          <li><a href="https://twitter.com/TheXC3LL">@TheXC3LL<strong>Twitter</strong></a></li>
          <li><a href="https://www.linkedin.com/in/thexc3ll/">thexc3ll<strong>LinkedIn</strong></a></li>
          <li><a href="https://mastodon.social/@XC3LL">@XC3LL<strong>Mastodon</strong></a></li>
        </ul>
        
               <nav>
  <ul>
    <li><a href="/">Home</a></li>
  <li><a href="/about.html">About</a></li>
    <li><a href="/cves.html">CVEs</a></li>
    <li><a href="/tools.html">Tools</a></li>
    <li><a href="/stuff.html">Slides & Articles</a></li>
  <li><a href="/rss.xml">RSS</a>/<a href="/atom.xml">Atom</a></li>
  
</ul>
</nav>
      </header>
      <section>

      <small>5 June 2019</small>
<h1>Stealthier communications & Port Knocking via Windows Filtering Platform (WFP)</h1>


<p>        
One of the key points of improvement that can be identified during an exercise between Red Team and Blue Team is the effectiveness in identifying compromised machines and eradicating deployed backdoors. A common problem we have found is that the Blue Team focuses its analysis only on those machines where high activity has been detected, leaving aside those with which the attacker has been able to interact but has done nothing “remarkable”.</p>

<p>        
To detect this type of problem, in our case it is common to leave <strong>“clean boxes”</strong> where a backdoor is simply implanted that allows, once the DFIR is finished by the Blue Team, to ensure persistence and retake control of the infrastructure. By “clean boxes” we mean those that are not used for pivoting or active use during the intrusion. Leaving behind this compromised machines, as a kind of canary, it is possible to detect if Blue Team has been able to trace all the machines the Red Team has had access to, or if there are blind spots in the detection that need to be remedied.</p>

<p>        
When the backdoor is implanted, it remains in hibernation mode, without any type of communication with the outside. It simply executes the necessary actions to persist in the host waiting to pass from “hibernation” mode to “active” mode. How do we tell the backdoor to activate? That’s where <strong>Windows Filtering Platform</strong> comes in.</p>

<h2 id="0x00-windows-filtering-platform-wfp">0x00 Windows Filtering Platform (WFP)</h2>

<p>        
Quoting official documentation:</p>

<blockquote>
  <p><em>Windows Filtering Platform (WFP) is a set of API and system services that provide a platform for creating network filtering applications. The WFP API allows developers to write code that interacts with the packet processing that takes place at several layers in the networking stack of the operating system. Network data can be filtered and also modified before it reaches its destination.</em></p>
</blockquote>

<p>        
Our backdoor instead of leaving some kind of port to listen to receive a packet that triggers some action (for example “switch to active mode” or anything else) what it will do is analyze, through the WFP APIs, the events of dropped UDP packets. In this way, without having to leave a suspicious listening socket, we can communicate with the backdoor. Of course there are tons of other approachs to accomplish this.</p>

<p>        
The MSDN has a <a href="https://docs.microsoft.com/es-es/windows/desktop/FWP/displaying-net-events">great example</a> of how we can snoop around net events:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fwpmtypes.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fwpmu.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="cp">#pragma comment (lib, "fwpuclnt.lib")
</span>
<span class="cp">#define EXIT_ON_ERROR(err) if((err) != ERROR_SUCCESS) {goto CLEANUP;}
</span>
<span class="c1">//#pragma comment (lib, "fwpuclnt.lib")</span>

<span class="n">DWORD</span> <span class="nf">InitFilterConditions</span><span class="p">(</span>
         <span class="n">__in_opt</span> <span class="n">PCWSTR</span> <span class="n">appPath</span><span class="p">,</span>
         <span class="n">__in_opt</span> <span class="k">const</span> <span class="n">SOCKADDR</span><span class="o">*</span> <span class="n">localAddr</span><span class="p">,</span>
         <span class="n">__in_opt</span> <span class="n">UINT8</span> <span class="n">ipProtocol</span><span class="p">,</span>
         <span class="n">__in</span> <span class="n">UINT32</span> <span class="n">numCondsIn</span><span class="p">,</span>
         <span class="n">__out_ecount_part</span><span class="p">(</span><span class="n">numCondsIn</span><span class="p">,</span> <span class="o">*</span><span class="n">numCondsOut</span><span class="p">)</span> <span class="n">FWPM_FILTER_CONDITION0</span><span class="o">*</span> <span class="n">conds</span><span class="p">,</span>
         <span class="n">__out</span> <span class="n">UINT32</span><span class="o">*</span> <span class="n">numCondsOut</span><span class="p">,</span>
         <span class="n">__deref_out</span> <span class="n">FWP_BYTE_BLOB</span><span class="o">**</span> <span class="n">appId</span>
         <span class="p">)</span>
<span class="p">{</span>
   <span class="o">*</span><span class="n">numCondsOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">ERROR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">DWORD</span> <span class="nf">FindRecentEvents</span><span class="p">(</span>
         <span class="n">__in</span> <span class="n">HANDLE</span> <span class="n">engine</span><span class="p">,</span>
         <span class="n">__in_opt</span> <span class="n">PCWSTR</span> <span class="n">appPath</span><span class="p">,</span>
         <span class="n">__in_opt</span> <span class="k">const</span> <span class="n">SOCKADDR</span><span class="o">*</span> <span class="n">localAddr</span><span class="p">,</span>
         <span class="n">__in_opt</span> <span class="n">UINT8</span> <span class="n">ipProtocol</span><span class="p">,</span>
         <span class="n">__in</span> <span class="n">UINT32</span> <span class="n">seconds</span><span class="p">,</span>
         <span class="n">__deref_out_ecount</span><span class="p">(</span><span class="o">*</span><span class="n">numEvents</span><span class="p">)</span> <span class="n">FWPM_NET_EVENT0</span><span class="o">***</span> <span class="n">events</span><span class="p">,</span>
         <span class="n">__out</span> <span class="n">UINT32</span><span class="o">*</span> <span class="n">numEvents</span>
         <span class="p">)</span>
<span class="p">{</span>
   <span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ERROR_SUCCESS</span><span class="p">;</span>
   <span class="n">FWPM_NET_EVENT_ENUM_TEMPLATE0</span> <span class="n">enumTempl</span><span class="p">;</span>
   <span class="n">ULARGE_INTEGER</span> <span class="n">ulTime</span><span class="p">;</span>
   <span class="n">FWPM_FILTER_CONDITION0</span> <span class="n">conds</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
   <span class="n">UINT32</span> <span class="n">numConds</span><span class="p">;</span>
   <span class="n">FWP_BYTE_BLOB</span><span class="o">*</span> <span class="n">appBlob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">HANDLE</span> <span class="n">enumHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enumTempl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">enumTempl</span><span class="p">));</span>

   <span class="c1">// Use the current time as the end time of the window.</span>
   <span class="n">GetSystemTimeAsFileTime</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">enumTempl</span><span class="p">.</span><span class="n">endTime</span><span class="p">));</span>

   <span class="c1">// Subtract the number of seconds specified by the caller to find the start</span>
   <span class="c1">// time.</span>
   <span class="n">ulTime</span><span class="p">.</span><span class="n">LowPart</span> <span class="o">=</span> <span class="n">enumTempl</span><span class="p">.</span><span class="n">endTime</span><span class="p">.</span><span class="n">dwLowDateTime</span><span class="p">;</span>
   <span class="n">ulTime</span><span class="p">.</span><span class="n">HighPart</span> <span class="o">=</span> <span class="n">enumTempl</span><span class="p">.</span><span class="n">endTime</span><span class="p">.</span><span class="n">dwHighDateTime</span><span class="p">;</span>
   <span class="n">ulTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-=</span> <span class="n">seconds</span> <span class="o">*</span> <span class="mi">10000000u</span><span class="n">i64</span><span class="p">;</span>
   <span class="n">enumTempl</span><span class="p">.</span><span class="n">startTime</span><span class="p">.</span><span class="n">dwLowDateTime</span> <span class="o">=</span> <span class="n">ulTime</span><span class="p">.</span><span class="n">LowPart</span><span class="p">;</span>
   <span class="n">enumTempl</span><span class="p">.</span><span class="n">startTime</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">=</span> <span class="n">ulTime</span><span class="p">.</span><span class="n">HighPart</span><span class="p">;</span>

   <span class="n">result</span> <span class="o">=</span> <span class="n">InitFilterConditions</span><span class="p">(</span>
               <span class="n">appPath</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">localAddr</span><span class="p">,</span>
               <span class="n">ipProtocol</span><span class="p">,</span>
               <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">conds</span><span class="p">),</span>
               <span class="n">conds</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">numConds</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">appBlob</span>
               <span class="p">);</span>
   <span class="n">EXIT_ON_ERROR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

   <span class="n">enumTempl</span><span class="p">.</span><span class="n">numFilterConditions</span> <span class="o">=</span> <span class="n">numConds</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">numConds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">enumTempl</span><span class="p">.</span><span class="n">filterCondition</span> <span class="o">=</span> <span class="n">conds</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">result</span> <span class="o">=</span> <span class="n">FwpmNetEventCreateEnumHandle0</span><span class="p">(</span>
               <span class="n">engine</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">enumTempl</span><span class="p">,</span>
               <span class="o">&amp;</span><span class="n">enumHandle</span>
               <span class="p">);</span>
   <span class="n">EXIT_ON_ERROR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

   <span class="n">result</span> <span class="o">=</span> <span class="n">FwpmNetEventEnum0</span><span class="p">(</span>
               <span class="n">engine</span><span class="p">,</span>
               <span class="n">enumHandle</span><span class="p">,</span>
               <span class="n">INFINITE</span><span class="p">,</span>
               <span class="n">events</span><span class="p">,</span>
               <span class="n">numEvents</span>
               <span class="p">);</span>
   <span class="n">EXIT_ON_ERROR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="nl">CLEANUP:</span>
   <span class="n">FwpmNetEventDestroyEnumHandle0</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">enumHandle</span><span class="p">);</span>
   <span class="n">FwpmFreeMemory0</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">appBlob</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DWORD</span> <span class="nf">wmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span>
            <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">argc</span><span class="p">);</span>
   <span class="n">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
   
   <span class="n">HANDLE</span> <span class="n">engineHandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">FWPM_NET_EVENT0</span><span class="o">**</span> <span class="n">events</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
   <span class="n">UINT32</span> <span class="n">numEvents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
   <span class="n">FILETIME</span> <span class="n">ft</span><span class="p">;</span>
   <span class="n">SYSTEMTIME</span> <span class="n">st</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">types</span><span class="p">[]</span> <span class="o">=</span>
   <span class="p">{</span>
      <span class="s">"FWPM_NET_EVENT_TYPE_IKEEXT_MM_FAILURE"</span><span class="p">,</span>
      <span class="s">"FWPM_NET_EVENT_TYPE_IKEEXT_QM_FAILURE"</span><span class="p">,</span>
      <span class="s">"FWPM_NET_EVENT_TYPE_IKEEXT_EM_FAILURE"</span><span class="p">,</span>
      <span class="s">"FWPM_NET_EVENT_TYPE_CLASSIFY_DROP"</span><span class="p">,</span>
      <span class="s">"FWPM_NET_EVENT_TYPE_IPSEC_KERNEL_DROP"</span>
   <span class="p">};</span>
   <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">type</span><span class="p">;</span>
   
   <span class="c1">// Use dynamic sessions for efficiency and safety:</span>
   <span class="c1">//  - All objects associated with the dynamic session are deleted with one call.</span>
   <span class="c1">//  - Filtering policy objects are deleted even when the application crashes. </span>
   <span class="n">FWPM_SESSION0</span> <span class="n">session</span><span class="p">;</span>
   <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">session</span><span class="p">));</span>
   <span class="n">session</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FWPM_SESSION_FLAG_DYNAMIC</span><span class="p">;</span>

   <span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">FwpmEngineOpen0</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_WINNT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">engineHandle</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">ERROR_SUCCESS</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
   <span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">FindRecentEvents</span><span class="p">(</span>
         <span class="n">engineHandle</span><span class="p">,</span>
         <span class="mi">0</span><span class="p">,</span>
         <span class="mi">0</span><span class="p">,</span>
         <span class="mi">0</span><span class="p">,</span>
         <span class="mi">100</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">events</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">numEvents</span>
         <span class="p">);</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">numEvents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"No events matched.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">else</span>
   <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Matching events:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numEvents</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

         <span class="n">FileTimeToLocalFileTime</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">timeStamp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ft</span><span class="p">);</span>
         <span class="n">FileTimeToSystemTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>

         <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">types</span><span class="p">))</span> <span class="o">?</span> <span class="n">types</span><span class="p">[</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]</span>
                                                 <span class="o">:</span> <span class="s">"&lt;unknown&gt;"</span><span class="p">;</span>

         <span class="n">printf</span><span class="p">(</span>
            <span class="s">"   %04hu/%02hu/%02hu:%02hu:%02hu:%02hu.%03hu - %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wYear</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wMonth</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wDay</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wHour</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wMinute</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wSecond</span><span class="p">,</span>
            <span class="n">st</span><span class="p">.</span><span class="n">wMilliseconds</span><span class="p">,</span>
            <span class="n">type</span>
            <span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>        
This fragment of code is perfect to use as a base template to build our functionality. Let’s play! <strong>:)</strong></p>

<h2 id="0x01-playing-with-events">0x01 Playing with events</h2>

<p>        
The <strong>FWPM_NET_EVENT0</strong> struct contains next fields:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FWPM_NET_EVENT0_</span> <span class="p">{</span>
  <span class="n">FWPM_NET_EVENT_HEADER0</span> <span class="n">header</span><span class="p">;</span>
  <span class="n">FWPM_NET_EVENT_TYPE</span>    <span class="n">type</span><span class="p">;</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">FWPM_NET_EVENT_IKEEXT_MM_FAILURE0</span> <span class="o">*</span><span class="n">ikeMmFailure</span><span class="p">;</span>
    <span class="n">FWPM_NET_EVENT_IKEEXT_QM_FAILURE0</span> <span class="o">*</span><span class="n">ikeQmFailure</span><span class="p">;</span>
    <span class="n">FWPM_NET_EVENT_IKEEXT_EM_FAILURE0</span> <span class="o">*</span><span class="n">ikeEmFailure</span><span class="p">;</span>
    <span class="n">FWPM_NET_EVENT_CLASSIFY_DROP0</span>     <span class="o">*</span><span class="n">classifyDrop</span><span class="p">;</span>
    <span class="n">FWPM_NET_EVENT_IPSEC_KERNEL_DROP0</span> <span class="o">*</span><span class="n">ipsecDrop</span><span class="p">;</span>
    <span class="n">FWPM_NET_EVENT_IPSEC_DOSP_DROP0</span>   <span class="o">*</span><span class="n">idpDrop</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span> <span class="n">FWPM_NET_EVENT0</span><span class="p">;</span>
</code></pre></div></div>
<p>        
And the <strong>header</strong> struct:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FWPM_NET_EVENT_HEADER0_</span> <span class="p">{</span>
  <span class="n">FILETIME</span>       <span class="n">timeStamp</span><span class="p">;</span>
  <span class="n">UINT32</span>         <span class="n">flags</span><span class="p">;</span>
  <span class="n">FWP_IP_VERSION</span> <span class="n">ipVersion</span><span class="p">;</span>
  <span class="n">UINT8</span>          <span class="n">ipProtocol</span><span class="p">;</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">UINT32</span>           <span class="n">localAddrV4</span><span class="p">;</span>
    <span class="n">FWP_BYTE_ARRAY16</span> <span class="n">localAddrV6</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">UINT32</span>           <span class="n">remoteAddrV4</span><span class="p">;</span>
    <span class="n">FWP_BYTE_ARRAY16</span> <span class="n">remoteAddrV6</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="n">UINT16</span>         <span class="n">localPort</span><span class="p">;</span>
  <span class="n">UINT16</span>         <span class="n">remotePort</span><span class="p">;</span>
  <span class="n">UINT32</span>         <span class="n">scopeId</span><span class="p">;</span>
  <span class="n">FWP_BYTE_BLOB</span>  <span class="n">appId</span><span class="p">;</span>
  <span class="n">SID</span>            <span class="o">*</span><span class="n">userId</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FWPM_NET_EVENT_HEADER0</span><span class="p">;</span>
</code></pre></div></div>

<p>        
As we can see, it is easy to retrieve the key information from the event, so we can know what port was hitted (and what was the remote address the package came from). We can display this information with a minimal modification from previous code snippet:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Based on https://docs.microsoft.com/es-es/windows/desktop/FWP/displaying-net-events */</span>


<span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fwpmtypes.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fwpmu.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;winsock.h&gt;</span><span class="cp">
</span>
<span class="cp">#pragma comment (lib, "fwpuclnt.lib")
#pragma comment (lib, "Ws2_32.lib")
</span>
<span class="cp">#define EXIT_ON_ERROR(err) if((err) != ERROR_SUCCESS) {goto CLEANUP;}
</span>

<span class="n">FILETIME</span> <span class="n">ft</span><span class="p">;</span>


<span class="n">DWORD</span> <span class="nf">InitFilterConditions</span><span class="p">(</span>
	<span class="n">__in_opt</span> <span class="n">PCWSTR</span> <span class="n">appPath</span><span class="p">,</span>
	<span class="n">__in_opt</span> <span class="k">const</span> <span class="n">SOCKADDR</span><span class="o">*</span> <span class="n">localAddr</span><span class="p">,</span>
	<span class="n">__in_opt</span> <span class="n">UINT8</span> <span class="n">ipProtocol</span><span class="p">,</span>
	<span class="n">__in</span> <span class="n">UINT32</span> <span class="n">numCondsIn</span><span class="p">,</span>
	<span class="n">__out_ecount_part</span><span class="p">(</span><span class="n">numCondsIn</span><span class="p">,</span> <span class="o">*</span><span class="n">numCondsOut</span><span class="p">)</span> <span class="n">FWPM_FILTER_CONDITION0</span><span class="o">*</span> <span class="n">conds</span><span class="p">,</span>
	<span class="n">__out</span> <span class="n">UINT32</span><span class="o">*</span> <span class="n">numCondsOut</span><span class="p">,</span>
	<span class="n">__deref_out</span> <span class="n">FWP_BYTE_BLOB</span><span class="o">**</span> <span class="n">appId</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">numCondsOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ERROR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">DWORD</span> <span class="nf">FindRecentEvents</span><span class="p">(</span>
	<span class="n">__in</span> <span class="n">HANDLE</span> <span class="n">engine</span><span class="p">,</span>
	<span class="n">__in_opt</span> <span class="n">PCWSTR</span> <span class="n">appPath</span><span class="p">,</span>
	<span class="n">__in_opt</span> <span class="k">const</span> <span class="n">SOCKADDR</span><span class="o">*</span> <span class="n">localAddr</span><span class="p">,</span>
	<span class="n">__in_opt</span> <span class="n">UINT8</span> <span class="n">ipProtocol</span><span class="p">,</span>
	<span class="n">__in</span> <span class="n">UINT32</span> <span class="n">seconds</span><span class="p">,</span>
	<span class="n">__deref_out_ecount</span><span class="p">(</span><span class="o">*</span><span class="n">numEvents</span><span class="p">)</span> <span class="n">FWPM_NET_EVENT0</span><span class="o">***</span> <span class="n">events</span><span class="p">,</span>
	<span class="n">__out</span> <span class="n">UINT32</span><span class="o">*</span> <span class="n">numEvents</span>
<span class="p">)</span>
<span class="p">{</span>
	<span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ERROR_SUCCESS</span><span class="p">;</span>
	<span class="n">FWPM_NET_EVENT_ENUM_TEMPLATE0</span> <span class="n">enumTempl</span><span class="p">;</span>
	<span class="n">ULARGE_INTEGER</span> <span class="n">ulTime</span><span class="p">;</span>
	<span class="n">FWPM_FILTER_CONDITION0</span> <span class="n">conds</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">UINT32</span> <span class="n">numConds</span><span class="p">;</span>
	<span class="n">FWP_BYTE_BLOB</span><span class="o">*</span> <span class="n">appBlob</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">enumHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enumTempl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">enumTempl</span><span class="p">));</span>

	<span class="c1">// Use the current time as the end time of the window.</span>
	<span class="n">GetSystemTimeAsFileTime</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">enumTempl</span><span class="p">.</span><span class="n">endTime</span><span class="p">));</span>

	<span class="c1">// Subtract the number of seconds specified by the caller to find the start</span>
	<span class="c1">// time.</span>
	<span class="n">ulTime</span><span class="p">.</span><span class="n">LowPart</span> <span class="o">=</span> <span class="n">enumTempl</span><span class="p">.</span><span class="n">endTime</span><span class="p">.</span><span class="n">dwLowDateTime</span><span class="p">;</span>
	<span class="n">ulTime</span><span class="p">.</span><span class="n">HighPart</span> <span class="o">=</span> <span class="n">enumTempl</span><span class="p">.</span><span class="n">endTime</span><span class="p">.</span><span class="n">dwHighDateTime</span><span class="p">;</span>
	<span class="n">ulTime</span><span class="p">.</span><span class="n">QuadPart</span> <span class="o">-=</span> <span class="n">seconds</span> <span class="o">*</span> <span class="mi">10000000u</span><span class="n">i64</span><span class="p">;</span>
	<span class="n">enumTempl</span><span class="p">.</span><span class="n">startTime</span><span class="p">.</span><span class="n">dwLowDateTime</span> <span class="o">=</span> <span class="n">ulTime</span><span class="p">.</span><span class="n">LowPart</span><span class="p">;</span>
	<span class="n">enumTempl</span><span class="p">.</span><span class="n">startTime</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">=</span> <span class="n">ulTime</span><span class="p">.</span><span class="n">HighPart</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">InitFilterConditions</span><span class="p">(</span>
		<span class="n">appPath</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">localAddr</span><span class="p">,</span>
		<span class="n">ipProtocol</span><span class="p">,</span>
		<span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">conds</span><span class="p">),</span>
		<span class="n">conds</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">numConds</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">appBlob</span>
	<span class="p">);</span>
	<span class="n">EXIT_ON_ERROR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">enumTempl</span><span class="p">.</span><span class="n">numFilterConditions</span> <span class="o">=</span> <span class="n">numConds</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numConds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">enumTempl</span><span class="p">.</span><span class="n">filterCondition</span> <span class="o">=</span> <span class="n">conds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">FwpmNetEventCreateEnumHandle0</span><span class="p">(</span>
		<span class="n">engine</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">enumTempl</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">enumHandle</span>
	<span class="p">);</span>
	<span class="n">EXIT_ON_ERROR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">FwpmNetEventEnum0</span><span class="p">(</span>
		<span class="n">engine</span><span class="p">,</span>
		<span class="n">enumHandle</span><span class="p">,</span>
		<span class="n">INFINITE</span><span class="p">,</span>
		<span class="n">events</span><span class="p">,</span>
		<span class="n">numEvents</span>
	<span class="p">);</span>
	<span class="n">EXIT_ON_ERROR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="nl">CLEANUP:</span>
	<span class="n">FwpmNetEventDestroyEnumHandle0</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">enumHandle</span><span class="p">);</span>
	<span class="n">FwpmFreeMemory0</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">appBlob</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">detectHit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_addr</span> <span class="n">rinaddr</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">engineHandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">FWPM_NET_EVENT0</span><span class="o">**</span> <span class="n">events</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="n">UINT32</span> <span class="n">numEvents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>


	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">types</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span>
	   <span class="s">"FWPM_NET_EVENT_TYPE_IKEEXT_MM_FAILURE"</span><span class="p">,</span>
	   <span class="s">"FWPM_NET_EVENT_TYPE_IKEEXT_QM_FAILURE"</span><span class="p">,</span>
	   <span class="s">"FWPM_NET_EVENT_TYPE_IKEEXT_EM_FAILURE"</span><span class="p">,</span>
	   <span class="s">"FWPM_NET_EVENT_TYPE_CLASSIFY_DROP"</span><span class="p">,</span>
	   <span class="s">"FWPM_NET_EVENT_TYPE_IPSEC_KERNEL_DROP"</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">type</span><span class="p">;</span>

	<span class="c1">// Use dynamic sessions for efficiency and safety:</span>
	<span class="c1">//  - All objects associated with the dynamic session are deleted with one call.</span>
	<span class="c1">//  - Filtering policy objects are deleted even when the application crashes. </span>
	<span class="n">FWPM_SESSION0</span> <span class="n">session</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">session</span><span class="p">));</span>
	<span class="n">session</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FWPM_SESSION_FLAG_DYNAMIC</span><span class="p">;</span>

	<span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">FwpmEngineOpen0</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_WINNT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">session</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">engineHandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ERROR_SUCCESS</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">FindRecentEvents</span><span class="p">(</span>
			<span class="n">engineHandle</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">100</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">events</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">numEvents</span>
		<span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numEvents</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numEvents</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>


			<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAYSIZE</span><span class="p">(</span><span class="n">types</span><span class="p">))</span> <span class="o">?</span> <span class="n">types</span><span class="p">[</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]</span>
				<span class="o">:</span> <span class="s">"&lt;unknown&gt;"</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">ipVersion</span> <span class="o">==</span> <span class="n">FWP_IP_VERSION_V4</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">ipProtocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">timeStamp</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">&gt;</span> <span class="n">ft</span><span class="p">.</span><span class="n">dwHighDateTime</span> 
					<span class="o">||</span> <span class="p">(</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">timeStamp</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">==</span> <span class="n">ft</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">timeStamp</span><span class="p">.</span><span class="n">dwLowDateTime</span> <span class="o">&gt;</span> <span class="n">ft</span><span class="p">.</span><span class="n">dwLowDateTime</span> <span class="p">)</span>
					<span class="p">)</span>
				<span class="p">)</span>
			<span class="p">{</span>
				<span class="n">rinaddr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">remoteAddrV4</span><span class="p">);</span>
				<span class="n">ft</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">timeStamp</span><span class="p">.</span><span class="n">dwHighDateTime</span><span class="p">;</span>
				<span class="n">ft</span><span class="p">.</span><span class="n">dwLowDateTime</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">timeStamp</span><span class="p">.</span><span class="n">dwLowDateTime</span><span class="p">;</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"[%s] - %d - %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">rinaddr</span><span class="p">),</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">localPort</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">remotePort</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
	<span class="n">ft</span><span class="p">.</span><span class="n">dwHighDateTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ft</span><span class="p">.</span><span class="n">dwLowDateTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">detectHit</span><span class="p">();</span>
		<span class="n">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>        
Running a nmap with -sU:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS D:\Debug&gt; .\WPM_PoC.exe
[192.168.252.197] - 5050 - 58982
[192.168.252.197] - 1900 - 58982
[192.168.252.197] - 3702 - 58982
[192.168.252.197] - 123 - 58982
(...)
</code></pre></div></div>

<p>        
It’s trivial to retrieve the remote and local port, and the remote IP, from the event. We can use this information to build the triggers needed, for example, swaping from “hibernation mode” to “active mode” when a particular port sequence is detected (building a <strong>Port Knocking</strong> engine this way). Or, another example, we can trigger predefined actions based on the packet source port. The source port can be set via Scapy, for example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">send</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s">"192.168.252.1"</span><span class="p">)</span><span class="o">/</span><span class="n">UDP</span><span class="p">(</span><span class="n">dport</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span><span class="n">sport</span><span class="o">=</span><span class="mi">666</span><span class="p">)</span><span class="o">/</span><span class="n">Raw</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="s">"Use stealthier packet in a real operation, pls"</span><span class="p">))</span>
</code></pre></div></div>

<p>        
With a simple switch we can evaluate what action to perform:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(...)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">localPort</span> <span class="o">==</span> <span class="mi">123</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">remotePort</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1337</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"COMMAND: 1337 - Activate Backdoor</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">666</span><span class="p">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"COMMAND: 666 - Reverse Shell</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="p">(...)</span>
</code></pre></div></div>
<p>        
And testing it with scapy:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS D:\Debug&gt; .\WPM_PoC.exe
COMMAND: 1337 - Activate Backdoor
COMMAND: 666 - Reverse Shell
(...)
</code></pre></div></div>

<h2 id="0x02-conclusions">0x02 Conclusions</h2>

<p>        
I encourage you to play a bit with the Windows Filtering Platform in order to build defensive and offensive toys. If you find useful this article, or wanna point me to an error or a typo, feel free to contact me at twitter <a href="https://twitter.com/TheXC3LL">@TheXC3LL</a>.</p>




      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/pages-themes">pages-themes</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>
